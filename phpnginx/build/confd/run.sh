#!/usr/bin/env bash

if [ "$CONFD_PREFIX" ]; then
    mkdir -p /etc/confd/conf.d /etc/confd/templates

    cat > /etc/confd/conf.d/.env.toml << EOF
[template]
prefix = "$CONFD_PREFIX"
src = ".env.tmpl"
dest = "/var/www/.env"
keys = ["/env"]
reload_cmd = "php /var/www/artisan queue:restart"
EOF

    cat > /etc/confd/templates/.env.tmpl << EOF
# This file is automatically generated by confd. Any changes will be overwritten.
{{range gets "/env/*"}}
{{base .Key}}={{.Value}}{{end}}
EOF

    /confd -backend consul -node consul:8500 -interval 60
fi